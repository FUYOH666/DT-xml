# Архитектура системы

## Обзор

Система поиска по таможенным декларациям ЕАЭС построена на платформенной архитектуре с использованием эмбедингов, гибридного поиска и адаптивного реранкинга. Система поддерживает динамические схемы данных для разных заказчиков.

## Компоненты

### 1. Управление схемами (платформенная архитектура)

- **Schema Manager**: Менеджер схем данных для заказчиков
- **Schema Registry**: Реестр схем заказчиков
- **Field Mapper**: Маппинг полей между форматами
- **Schema Validator**: Валидация по динамической схеме

### 2. Парсинг и нормализация

- **XML Parser**: Парсинг XML деклараций ЕАЭС (с поддержкой динамических схем)
- **OCR Processor**: Обработка OCR результатов как fallback
- **Field Extractor**: Извлечение полей из неструктурированного текста
- **Normalizer**: Нормализация полей, языков, кодов
- **Schema Validator**: Валидация структуры деклараций

### 2. Индексация

- **Chunker**: Семантическое чанкование документов
- **Embedder**: Генерация многоязычных эмбедингов
- **Vector Store**: Хранение эмбедингов в Qdrant
- **Metadata Store**: Хранение метаданных в PostgreSQL

### 3. Поиск

- **Sparse Search**: BM25/keyword поиск
- **Dense Search**: Векторный поиск по эмбедингам
- **Hybrid Search**: Объединение sparse и dense результатов (RRF)

### 4. Реранкинг

- **Adaptive Reranker**: Адаптивный выбор модели реранкера
- **Query Complexity**: Анализ сложности запроса
- **Explainability**: Объяснимость результатов

### 5. Временная осведомленность

- **Temporal Awareness**: Учет временных изменений
- **Rule Versioning**: Версионирование правил ЕАЭС

## Поток данных

```
Входные данные (XML/JSON/OCR)
    ↓
Определение tenant_id
    ↓
Загрузка схемы заказчика
    ↓
Маппинг полей (если нужно)
    ↓
Валидация обязательных полей для поиска
    ↓
Если OCR → Field Extractor → Нормализация
    ↓
Парсинг → Нормализация → Чанкование
    ↓
Генерация эмбедингов
    ↓
Сохранение в Vector DB + Metadata DB
    ↓
Поисковый запрос (с tenant_id)
    ↓
Загрузка настроек поиска заказчика
    ↓
Гибридный поиск (Sparse + Dense)
    ↓
Адаптивный реранкинг
    ↓
Временная корректировка
    ↓
Объяснимость результатов
    ↓
Ответ API
```

## Платформенная архитектура

Система поддерживает мультитенантность на уровне схем данных:

- **Один инстанс на заказчика**: Каждый заказчик имеет свой инстанс системы
- **Динамические схемы**: Каждый заказчик может определить свою схему данных
- **Маппинг полей**: Автоматическое преобразование полей из входного формата
- **Настройки обработки**: Индивидуальные настройки для каждого заказчика
- **Настройки поиска**: Кастомизация поиска (boost полей, фильтры)

## Технологии

- **Python 3.12+** с **uv**
- **FastAPI** для REST API
- **Qdrant** для векторной БД
- **PostgreSQL** для метаданных
- **SentenceTransformers** для эмбедингов
- **CrossEncoder** для реранкинга

## Масштабируемость

Система спроектирована для обработки 10 000+ деклараций с возможностью горизонтального масштабирования через:

- Распределенную векторную БД (Qdrant cluster)
- Репликацию PostgreSQL
- Батчинг при индексации
- Кэширование частых запросов
